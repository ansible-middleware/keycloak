---
- name: "Restart and enable {{ keycloak.service_name }} service"
  ansible.builtin.systemd:
    name: "{{ keycloak.service_name }}"
    enabled: true
    state: restarted
    daemon_reload: true
  become: true

- name: "Fail if health check URL does not use port 9000 while health is enabled"
  ansible.builtin.fail:
    msg: "When `keycloak_quarkus_health_enabled` is true, the health check URL must use port 9000. Current URL: {{ keycloak_quarkus_health_check_url }}"
  when: keycloak_quarkus_health_enabled | bool and keycloak_quarkus_health_check_url is defined and (keycloak_quarkus_health_check_url | regex_search(':(\\d+)', '\\1') | int) != 9000

- name: "Wait until {{ keycloak.service_name }} service becomes active {{ keycloak.health_url }}"
  ansible.builtin.uri:
    url: "{{ keycloak.health_url }}"
  register: keycloak_status
  until: keycloak_status.status == 200
  retries: "{{ keycloak_quarkus_restart_health_check_retries }}"
  delay: "{{ keycloak_quarkus_restart_health_check_delay }}"
  when: internal_force_health_check | default(keycloak_quarkus_restart_health_check)

- name: Wait to give distributed ispn caches time to (re-)replicate back onto first host
  ansible.builtin.pause:
    seconds: "{{ keycloak_quarkus_restart_pause }}"
  when:
    - keycloak_quarkus_ha_enabled
